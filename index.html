<!-- Mobile QA checklist: verify no horizontal scroll at 390x844, 360x740, 844x390; current row + palette usable; submit visible; history accessible. -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Logic â€” Board Interface</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Trebuchet MS", "Segoe UI", Tahoma, sans-serif;
        background-color: #e6dcc2;
        color: #3d3526;
        --safe-left: env(safe-area-inset-left);
        --safe-right: env(safe-area-inset-right);
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
        --socket-size: 58px;
        --socket-gap: 12px;
        --feedback-size: 18px;
        --feedback-gap: 6px;
        --peg-size: 42px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: calc(24px + var(--safe-top)) calc(24px + var(--safe-right))
          calc(24px + var(--safe-bottom)) calc(24px + var(--safe-left));
        background: radial-gradient(circle at top, #efe5c8 0%, #e3d4b3 60%, #d8c6a1 100%);
      }

      .game-shell {
        display: flex;
        justify-content: center;
        max-width: 100%;
      }

      .board-frame {
        padding: 24px;
        background: linear-gradient(180deg, #f2e6c8 0%, #e3d4b3 100%);
        border-radius: 28px;
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.8),
          inset 0 -6px 12px rgba(117, 96, 62, 0.35),
          0 24px 40px rgba(72, 56, 32, 0.25);
        max-width: 100%;
      }

      .board {
        min-width: 920px;
        display: grid;
        grid-template-columns: minmax(540px, 1fr) minmax(260px, 320px);
        gap: 24px;
        background: #e8d7b8;
        padding: 24px;
        border-radius: 24px;
        box-shadow: inset 0 0 0 2px rgba(108, 84, 47, 0.25),
          inset 0 20px 30px rgba(255, 255, 255, 0.3);
      }

      .board-playfield {
        transform: scale(var(--board-scale, 1));
        transform-origin: top center;
      }

      .secret-row {
        position: relative;
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 24px;
        padding: 16px 20px;
        border-radius: 20px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.4), rgba(214, 190, 148, 0.6));
        box-shadow: inset 0 2px 6px rgba(92, 72, 40, 0.35);
      }

      .secret-label {
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        font-size: 0.8rem;
      }

      .secret-sockets {
        display: grid;
        grid-template-columns: repeat(5, calc(var(--socket-size) + 6px));
        gap: 14px;
      }

      .secret-row.revealed .secret-cover {
        transform: translateY(-120%);
        opacity: 0;
      }

      .secret-cover {
        position: absolute;
        inset: 10px 20px 10px 140px;
        background: linear-gradient(180deg, #c6b18a 0%, #b2996a 100%);
        border-radius: 18px;
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4),
          inset 0 -6px 10px rgba(80, 63, 34, 0.4);
        transition: transform 0.6s ease, opacity 0.6s ease;
        pointer-events: none;
      }

      .attempts-area {
        display: grid;
        grid-template-columns: 1fr 40px;
        gap: 16px;
      }

      .attempts-grid {
        display: grid;
        gap: 12px;
      }

      .attempt-row {
        display: grid;
        grid-template-columns: 1fr 130px;
        align-items: center;
        padding: 10px 16px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.25);
        box-shadow: inset 0 1px 3px rgba(94, 73, 43, 0.25);
        position: relative;
      }

      .attempt-row.current {
        box-shadow: 0 0 0 2px rgba(112, 84, 45, 0.6),
          inset 0 2px 6px rgba(94, 73, 43, 0.35);
      }

      .guess-sockets {
        display: grid;
        grid-template-columns: repeat(5, var(--socket-size));
        gap: var(--socket-gap);
      }

      .feedback-sockets {
        display: grid;
        grid-template-columns: repeat(3, var(--feedback-size));
        grid-template-rows: repeat(2, var(--feedback-size));
        gap: var(--feedback-gap);
        justify-content: center;
      }

      .row-numbers {
        display: grid;
        grid-template-rows: repeat(12, 1fr);
        gap: 12px;
        align-content: start;
        padding-top: 10px;
      }

      .row-number {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 10px;
        font-weight: 700;
        color: #5a4a2f;
        background: rgba(255, 255, 255, 0.4);
        box-shadow: inset 0 1px 3px rgba(94, 73, 43, 0.2);
      }

      .socket {
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #f7f0df 0%, #e2d1af 55%, #c1a57a 100%);
        box-shadow: inset 2px 2px 4px rgba(255, 255, 255, 0.6),
          inset -4px -4px 6px rgba(90, 67, 36, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .socket.large {
        width: var(--socket-size);
        height: var(--socket-size);
      }

      .socket.small {
        width: var(--feedback-size);
        height: var(--feedback-size);
      }

      .socket.interactive {
        cursor: pointer;
      }

      .socket.interactive:focus-visible {
        outline: 2px solid #7f5c2d;
        outline-offset: 3px;
      }

      .socket.interactive.ready {
        box-shadow: 0 0 0 3px rgba(127, 92, 45, 0.4),
          inset 2px 2px 4px rgba(255, 255, 255, 0.6),
          inset -4px -4px 6px rgba(90, 67, 36, 0.45);
      }

      .peg {
        border-radius: 50%;
        box-shadow: inset -2px -2px 4px rgba(0, 0, 0, 0.3),
          inset 2px 2px 4px rgba(255, 255, 255, 0.4);
      }

      .peg.large {
        width: var(--peg-size);
        height: var(--peg-size);
      }

      .peg.small {
        width: calc(var(--feedback-size) - 6px);
        height: calc(var(--feedback-size) - 6px);
        border: 1px solid rgba(0, 0, 0, 0.2);
      }

      .peg.black {
        background: #1b1a17;
      }

      .peg.white {
        background: #f7f5f0;
      }

      .controls-panel {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .status-plaques {
        display: grid;
        gap: 10px;
      }

      .plaque {
        padding: 10px 14px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.5);
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.8),
          inset 0 -3px 6px rgba(92, 72, 40, 0.25);
        font-weight: 700;
      }

      .tray {
        padding: 14px 16px;
        border-radius: 18px;
        background: linear-gradient(180deg, #ead8b6 0%, #d7c29a 100%);
        box-shadow: inset 0 2px 6px rgba(86, 66, 37, 0.3);
      }

      .tray-label {
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        margin-bottom: 10px;
        letter-spacing: 0.08em;
      }

      .palette {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }

      .tray-peg {
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 8px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 0 0 2px rgba(105, 82, 47, 0.3);
      }

      .tray-peg.selected {
        box-shadow: 0 0 0 3px #7f5c2d;
      }

      .tray-peg:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .board-controls {
        display: grid;
        gap: 10px;
      }

      .board-controls button {
        padding: 12px 16px;
        border-radius: 14px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        background: #7f5c2d;
        color: #fef7e6;
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.35),
          inset 0 -3px 5px rgba(57, 41, 19, 0.5);
      }

      .board-controls button.secondary {
        background: #d8c09a;
        color: #4a3b26;
      }

      .board-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .board-hint {
        font-size: 0.85rem;
        color: #5d503a;
        line-height: 1.4;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .desktop-layout {
        flex: 1;
      }

      .mobile-layout {
        display: none;
        width: min(100%, 560px);
        margin: 0 auto;
        padding: 16px;
        border-radius: 24px;
        background: linear-gradient(180deg, rgba(242, 230, 200, 0.8), rgba(224, 210, 180, 0.9));
        box-shadow: inset 0 2px 6px rgba(86, 66, 37, 0.3),
          0 12px 24px rgba(72, 56, 32, 0.18);
      }

      .mobile-status {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 14px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.6);
        box-shadow: inset 0 1px 3px rgba(94, 73, 43, 0.25);
      }

      .mobile-status-text {
        display: grid;
        gap: 4px;
        font-weight: 700;
      }

      .mobile-new-game {
        border: none;
        border-radius: 14px;
        padding: 10px 14px;
        font-weight: 700;
        background: #7f5c2d;
        color: #fef7e6;
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.35),
          inset 0 -3px 5px rgba(57, 41, 19, 0.5);
        cursor: pointer;
      }

      .mobile-section-title {
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        margin-bottom: 10px;
      }

      .mobile-current,
      .mobile-history,
      .mobile-palette {
        margin-top: 16px;
      }

      .mobile-current-row {
        display: grid;
        grid-template-columns: repeat(5, minmax(48px, 1fr));
        gap: 10px;
        padding: 14px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.5);
        box-shadow: inset 0 1px 3px rgba(94, 73, 43, 0.25);
      }

      .mobile-current-row .socket {
        width: 52px;
        height: 52px;
      }

      .mobile-history-list {
        display: grid;
        gap: 12px;
        max-height: 320px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .mobile-layout {
        --mh-token: 34px;
        --mh-gap: 8px;
      }

      .m-history__row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.35);
        box-shadow: inset 0 1px 3px rgba(94, 73, 43, 0.2);
        max-width: 100%;
      }

      .m-history__guess {
        display: flex;
        flex-wrap: nowrap;
        gap: var(--mh-gap);
        align-items: center;
        flex: 1 1 auto;
        min-width: 0;
      }

      /* History tokens intentionally avoid socket styling for readability. */
      .m-history__token {
        width: var(--mh-token);
        height: var(--mh-token);
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(0, 0, 0, 0.15);
        box-shadow: 0 1px 2px rgba(58, 44, 24, 0.2);
        flex: 0 0 auto;
      }

      .m-history__token--empty {
        background: rgba(255, 255, 255, 0.5);
      }

      .m-history__feedback {
        display: grid;
        grid-template-columns: repeat(2, 12px);
        gap: 4px;
        flex: 0 0 auto;
      }

      .m-history__feedback .socket {
        width: 12px;
        height: 12px;
      }

      .mobile-secret {
        display: none;
        margin-top: 16px;
        padding: 12px 14px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.5);
        box-shadow: inset 0 1px 3px rgba(94, 73, 43, 0.25);
      }

      .mobile-secret.revealed {
        display: block;
      }

      .mobile-secret-sockets {
        display: grid;
        grid-template-columns: repeat(5, 34px);
        gap: 8px;
        margin-top: 8px;
      }

      .mobile-secret-sockets .socket {
        width: 34px;
        height: 34px;
      }

      .palette-mobile {
        grid-template-columns: repeat(4, 1fr);
      }

      .palette-mobile .tray-peg {
        min-height: 56px;
      }

      .mobile-sticky {
        position: sticky;
        bottom: calc(8px + var(--safe-bottom));
        margin-top: 20px;
        padding: 14px;
        border-radius: 22px;
        background: linear-gradient(180deg, rgba(234, 216, 182, 0.95), rgba(215, 194, 154, 0.95));
        box-shadow: inset 0 2px 6px rgba(86, 66, 37, 0.3),
          0 12px 24px rgba(72, 56, 32, 0.18);
      }

      .mobile-controls {
        display: grid;
        gap: 10px;
        margin-top: 12px;
      }

      .mobile-controls button {
        padding: 12px 16px;
        border-radius: 14px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        background: #7f5c2d;
        color: #fef7e6;
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.35),
          inset 0 -3px 5px rgba(57, 41, 19, 0.5);
      }

      .mobile-controls button.secondary {
        background: #d8c09a;
        color: #4a3b26;
      }

      .mobile-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .debug-indicator {
        position: fixed;
        bottom: calc(12px + var(--safe-bottom));
        right: calc(12px + var(--safe-right));
        padding: 6px 10px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.7);
        color: #fef7e6;
        font-size: 0.75rem;
        z-index: 1000;
      }

      @media (max-width: 900px) {
        body {
          padding: 16px;
        }

        .board {
          min-width: 820px;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: calc(16px + var(--safe-top)) calc(16px + var(--safe-right))
            calc(16px + var(--safe-bottom)) calc(16px + var(--safe-left));
        }

        .game-shell {
          justify-content: stretch;
        }

        .desktop-layout {
          display: none;
        }

        .mobile-layout {
          display: block;
        }

        .mobile-layout {
          padding-bottom: calc(240px + var(--safe-bottom));
        }

        .board {
          min-width: 0;
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .controls-panel {
          order: 2;
        }

        .board-playfield {
          order: 1;
        }
      }

      @media (max-width: 480px) {
        :root {
          --socket-size: 48px;
          --socket-gap: 10px;
          --feedback-size: 16px;
          --feedback-gap: 6px;
          --peg-size: 34px;
        }

        .board-frame {
          padding: 16px;
        }

        .attempts-area {
          grid-template-columns: 1fr;
        }

        .attempt-row {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .feedback-sockets {
          justify-content: flex-start;
        }

        .row-numbers {
          display: none;
        }

        .board-controls button {
          width: 100%;
        }
      }

      @media (max-width: 360px) {
        .mobile-layout {
          --mh-token: 30px;
          --mh-gap: 6px;
        }

        .m-history__guess {
          flex-wrap: wrap;
        }
      }

      .condensed .attempt-row {
        padding: 8px 12px;
      }

      .condensed .attempt-row:not(.current) {
        --socket-size: 34px;
        --socket-gap: 8px;
        --feedback-size: 12px;
        --feedback-gap: 4px;
        --peg-size: 24px;
        opacity: 0.9;
      }

      .condensed .attempt-row.current {
        --socket-size: 50px;
        --socket-gap: 10px;
        --feedback-size: 16px;
        --feedback-gap: 6px;
        --peg-size: 36px;
      }
    </style>
  </head>
  <body>
    <main class="game-shell">
      <section class="board-frame desktop-layout" aria-label="Logic board">
        <div class="board">
          <div class="board-playfield" id="board-playfield">
            <div class="secret-row" id="secret-row">
              <div class="secret-label">Secret Code</div>
              <div class="secret-sockets" id="secret-sockets"></div>
              <div class="secret-cover" id="secret-cover"></div>
            </div>

            <div class="attempts-area">
              <div class="attempts-grid" id="attempt-rows"></div>
              <div class="row-numbers" id="row-numbers"></div>
            </div>
          </div>

          <aside class="controls-panel">
            <div class="status-plaques">
              <div class="plaque" id="attempt-counter">Attempt 1 / 12</div>
              <div class="plaque" id="game-status">Status: Playing</div>
            </div>

            <div class="tray">
              <div class="tray-label">Peg Tray</div>
              <div class="palette" id="palette-desktop"></div>
            </div>

            <div class="board-controls">
              <button id="submit-guess" disabled>Submit Guess</button>
              <button class="secondary" id="clear-guess">Clear Row</button>
              <button class="secondary" id="new-game">New Game</button>
            </div>

            <p class="board-hint">
              Select a peg color, then place it into the current row. Feedback pegs appear
              after submission (black first, then white). The secret cover opens when the
              game ends.
            </p>
          </aside>
        </div>
      </section>

      <section class="mobile-layout" aria-label="Logic mobile board">
        <div class="mobile-status">
          <div class="mobile-status-text">
            <div class="mobile-attempt" id="mobile-attempt-counter">Attempt 1 / 12</div>
            <div class="mobile-game-status" id="mobile-game-status">Status: Playing</div>
          </div>
          <button class="mobile-new-game" id="mobile-new-game">New Game</button>
        </div>

        <div class="mobile-secret" id="mobile-secret">
          <div class="mobile-secret-label">Secret Code</div>
          <div class="mobile-secret-sockets" id="mobile-secret-sockets"></div>
        </div>

        <div class="mobile-current">
          <div class="mobile-section-title">Current Attempt</div>
          <div class="mobile-current-row" id="mobile-current-row"></div>
        </div>

        <div class="mobile-history">
          <div class="mobile-section-title">Attempt History</div>
          <div class="mobile-history-list" id="mobile-history-list"></div>
        </div>

        <div class="mobile-sticky">
          <div class="mobile-palette">
            <div class="mobile-section-title">Palette</div>
            <div class="palette palette-mobile" id="palette-mobile"></div>
          </div>

          <div class="mobile-controls">
            <button id="mobile-submit-guess" disabled>Submit Guess</button>
            <button class="secondary" id="mobile-clear-guess">Clear Row</button>
            <button class="secondary" id="mobile-backspace">Backspace</button>
          </div>
        </div>
      </section>
    </main>

    <div id="debug-indicator" class="debug-indicator" hidden></div>

    <div id="status-live" class="sr-only" aria-live="polite"></div>

    <script>
      /*
        Mobile QA:
        - Open ?debug=1 to show viewport/scroll diagnostics and input logging.
        - Test at 390x844, 360x740, 844x390 to ensure no horizontal scroll.
        - Verify tap-to-place works end-to-end, submit is reachable, and history scrolls.
      */
      const COLORS = [
        { id: 0, name: "Color 1", hex: "#ef4444" },
        { id: 1, name: "Color 2", hex: "#f97316" },
        { id: 2, name: "Color 3", hex: "#facc15" },
        { id: 3, name: "Color 4", hex: "#22c55e" },
        { id: 4, name: "Color 5", hex: "#14b8a6" },
        { id: 5, name: "Color 6", hex: "#3b82f6" },
        { id: 6, name: "Color 7", hex: "#8b5cf6" },
        { id: 7, name: "Color 8", hex: "#ec4899" },
      ];

      const MAX_ATTEMPTS = 12;
      const CODE_LENGTH = 5;
      const MOBILE_BREAKPOINT = 768;
      const DEBUG_UI = window.location.search.includes("debug=1");

      const state = {
        secretCode: [],
        attempts: [],
        currentGuess: Array(CODE_LENGTH).fill(null),
        status: "playing",
      };

      let selectedColorId = null;

      const attemptRowsEl = document.getElementById("attempt-rows");
      const paletteDesktopEl = document.getElementById("palette-desktop");
      const paletteMobileEl = document.getElementById("palette-mobile");
      const secretSocketsEl = document.getElementById("secret-sockets");
      const secretRowEl = document.getElementById("secret-row");
      const attemptCounterEl = document.getElementById("attempt-counter");
      const statusEl = document.getElementById("game-status");
      const submitBtn = document.getElementById("submit-guess");
      const clearBtn = document.getElementById("clear-guess");
      const newGameBtn = document.getElementById("new-game");
      const mobileAttemptCounterEl = document.getElementById("mobile-attempt-counter");
      const mobileStatusEl = document.getElementById("mobile-game-status");
      const mobileNewGameBtn = document.getElementById("mobile-new-game");
      const mobileSubmitBtn = document.getElementById("mobile-submit-guess");
      const mobileClearBtn = document.getElementById("mobile-clear-guess");
      const mobileBackspaceBtn = document.getElementById("mobile-backspace");
      const mobileCurrentRowEl = document.getElementById("mobile-current-row");
      const mobileHistoryListEl = document.getElementById("mobile-history-list");
      const mobileSecretEl = document.getElementById("mobile-secret");
      const mobileSecretSocketsEl = document.getElementById("mobile-secret-sockets");
      const rowNumbersEl = document.getElementById("row-numbers");
      const statusLiveEl = document.getElementById("status-live");
      const boardPlayfieldEl = document.getElementById("board-playfield");
      const boardFrameEl = document.querySelector(".board-frame");
      const debugIndicatorEl = document.getElementById("debug-indicator");

      function generateSecretCode() {
        // Random code generation with repeats allowed.
        return Array.from({ length: CODE_LENGTH }, () =>
          Math.floor(Math.random() * COLORS.length)
        );
      }

      function evaluateGuess(code, guess) {
        // Feedback algorithm with duplicate handling:
        // First count black pegs and mark used positions,
        // then count whites using remaining occurrences in the code.
        let black = 0;
        const codeUsed = Array(CODE_LENGTH).fill(false);
        const guessUsed = Array(CODE_LENGTH).fill(false);

        for (let i = 0; i < CODE_LENGTH; i += 1) {
          if (code[i] === guess[i]) {
            black += 1;
            codeUsed[i] = true;
            guessUsed[i] = true;
          }
        }

        const remainingCounts = Array(COLORS.length).fill(0);
        for (let i = 0; i < CODE_LENGTH; i += 1) {
          if (!codeUsed[i]) {
            remainingCounts[code[i]] += 1;
          }
        }

        let white = 0;
        for (let i = 0; i < CODE_LENGTH; i += 1) {
          if (guessUsed[i]) {
            continue;
          }
          const color = guess[i];
          if (remainingCounts[color] > 0) {
            white += 1;
            remainingCounts[color] -= 1;
          }
        }

        return { black, white };
      }

      function runFeedbackTests() {
        // Test cases for feedback correctness, including duplicates.
        console.info("Running feedback tests...");
        console.info(
          "All correct:",
          evaluateGuess([0, 1, 2, 3, 4], [0, 1, 2, 3, 4])
        );
        console.info(
          "No matches:",
          evaluateGuess([0, 1, 2, 3, 4], [5, 6, 7, 5, 6])
        );
        console.info(
          "All misplaced:",
          evaluateGuess([0, 1, 2, 3, 4], [1, 2, 3, 4, 0])
        );
        console.info(
          "Duplicate limitation:",
          evaluateGuess([0, 0, 1, 2, 3], [0, 0, 0, 0, 0])
        );
        console.info(
          "Mixed duplicates:",
          evaluateGuess([0, 1, 1, 2, 2], [1, 1, 0, 2, 3])
        );
      }

      function createPeg(colorHex, sizeClass) {
        const peg = document.createElement("div");
        peg.className = `peg ${sizeClass}`;
        peg.style.background = colorHex;
        return peg;
      }

      function createSocket(sizeClass, label, interactive = false) {
        const socket = document.createElement("div");
        socket.className = `socket ${sizeClass}`;
        socket.setAttribute("aria-label", label);
        if (interactive) {
          socket.classList.add("interactive");
          if (selectedColorId !== null) {
            socket.classList.add("ready");
          }
          socket.setAttribute("role", "button");
          socket.tabIndex = 0;
        }
        return socket;
      }

      function debugLog(message, payload = "") {
        if (DEBUG_UI) {
          if (payload !== "") {
            console.info(message, payload);
          } else {
            console.info(message);
          }
        }
      }

      function renderSecretCode() {
        secretSocketsEl.innerHTML = "";
        for (let i = 0; i < CODE_LENGTH; i += 1) {
          const socket = createSocket("large", `Secret position ${i + 1}`);
          if (state.status !== "playing") {
            const colorId = state.secretCode[i];
            socket.appendChild(createPeg(COLORS[colorId].hex, "large"));
          }
          secretSocketsEl.appendChild(socket);
        }
        if (state.status === "playing") {
          secretRowEl.classList.remove("revealed");
        } else {
          secretRowEl.classList.add("revealed");
        }
      }

      function renderMobileSecretCode() {
        mobileSecretSocketsEl.innerHTML = "";
        for (let i = 0; i < CODE_LENGTH; i += 1) {
          const socket = createSocket("large", `Secret position ${i + 1}`);
          if (state.status !== "playing") {
            const colorId = state.secretCode[i];
            socket.appendChild(createPeg(COLORS[colorId].hex, "large"));
          }
          mobileSecretSocketsEl.appendChild(socket);
        }

        if (state.status === "playing") {
          mobileSecretEl.classList.remove("revealed");
        } else {
          mobileSecretEl.classList.add("revealed");
        }
      }

      function renderRowNumbers() {
        rowNumbersEl.innerHTML = "";
        for (let i = 1; i <= MAX_ATTEMPTS; i += 1) {
          const number = document.createElement("div");
          number.className = "row-number";
          number.textContent = i;
          rowNumbersEl.appendChild(number);
        }
      }

      function setCurrentGuessAt(position, colorId) {
        if (state.status !== "playing") {
          return;
        }
        state.currentGuess[position] = colorId;
      }

      function handleSocketPlacement(position) {
        if (selectedColorId === null) {
          setCurrentGuessAt(position, null);
        } else {
          setCurrentGuessAt(position, selectedColorId);
        }
        debugLog("Socket tapped", { position, selectedColorId });
        renderAll();
        updateStatus();
      }

      function renderAttempts() {
        attemptRowsEl.innerHTML = "";
        const currentRowIndex = state.attempts.length;
        const allowDrag = !isTouchLayout();

        for (let rowIndex = 0; rowIndex < MAX_ATTEMPTS; rowIndex += 1) {
          const row = document.createElement("div");
          row.className = "attempt-row";
          if (state.status === "playing" && rowIndex === currentRowIndex) {
            row.classList.add("current");
          }

          const guessSockets = document.createElement("div");
          guessSockets.className = "guess-sockets";

          let guessValues = Array(CODE_LENGTH).fill(null);
          if (rowIndex < state.attempts.length) {
            guessValues = state.attempts[rowIndex].guess;
          } else if (rowIndex === currentRowIndex && state.status === "playing") {
            guessValues = state.currentGuess;
          }

          guessValues.forEach((colorId, position) => {
            const label = `Attempt ${rowIndex + 1}, position ${position + 1} socket`;
            const interactive =
              state.status === "playing" && rowIndex === currentRowIndex;
            const socket = createSocket("large", label, interactive);

            if (colorId !== null) {
              socket.appendChild(createPeg(COLORS[colorId].hex, "large"));
            }

            if (interactive) {
              socket.addEventListener("click", () => handleSocketPlacement(position));
              socket.addEventListener("keydown", (event) => {
                if (event.key === "Enter" || event.key === " ") {
                  event.preventDefault();
                  handleSocketPlacement(position);
                }
              });
              if (allowDrag) {
                socket.addEventListener("dragover", (event) => {
                  event.preventDefault();
                });
                socket.addEventListener("drop", (event) => {
                  event.preventDefault();
                  const colorIdText = event.dataTransfer.getData("text/plain");
                  if (colorIdText !== "") {
                    selectedColorId = Number(colorIdText);
                    state.currentGuess[position] = selectedColorId;
                    renderAll();
                    updateStatus();
                  }
                });
              }
            }

            guessSockets.appendChild(socket);
          });

          const feedbackSockets = document.createElement("div");
          feedbackSockets.className = "feedback-sockets";
          let feedback = { black: 0, white: 0 };
          if (rowIndex < state.attempts.length) {
            feedback = state.attempts[rowIndex];
          }

          const feedbackPegs = [
            ...Array(feedback.black).fill("black"),
            ...Array(feedback.white).fill("white"),
            ...Array(CODE_LENGTH - feedback.black - feedback.white).fill("empty"),
          ];

          feedbackPegs.forEach((type, index) => {
            const socket = createSocket(
              "small",
              `Attempt ${rowIndex + 1}, feedback socket ${index + 1}`
            );
            if (type === "black") {
              const peg = document.createElement("div");
              peg.className = "peg small black";
              socket.appendChild(peg);
            } else if (type === "white") {
              const peg = document.createElement("div");
              peg.className = "peg small white";
              socket.appendChild(peg);
            }
            feedbackSockets.appendChild(socket);
          });

          row.appendChild(guessSockets);
          row.appendChild(feedbackSockets);
          attemptRowsEl.appendChild(row);
        }
      }

      function renderMobileCurrentRow() {
        mobileCurrentRowEl.innerHTML = "";
        state.currentGuess.forEach((colorId, position) => {
          const label = `Current attempt, position ${position + 1} socket`;
          const socket = createSocket("large", label, state.status === "playing");
          if (colorId !== null) {
            socket.appendChild(createPeg(COLORS[colorId].hex, "large"));
          }
          if (state.status === "playing") {
            socket.addEventListener("click", () => handleSocketPlacement(position));
            socket.addEventListener("keydown", (event) => {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                handleSocketPlacement(position);
              }
            });
          }
          mobileCurrentRowEl.appendChild(socket);
        });
      }

      function renderMobileHistory() {
        mobileHistoryListEl.innerHTML = "";
        if (state.attempts.length === 0) {
          const empty = document.createElement("div");
          empty.className = "board-hint";
          empty.textContent = "No attempts yet.";
          mobileHistoryListEl.appendChild(empty);
          return;
        }

        state.attempts.forEach((attempt, index) => {
          const row = document.createElement("div");
          row.className = "m-history__row";

          const guess = document.createElement("div");
          guess.className = "m-history__guess";
          attempt.guess.forEach((colorId, position) => {
            const token = document.createElement("div");
            token.className = "m-history__token";
            token.setAttribute(
              "aria-label",
              `Attempt ${index + 1}, position ${position + 1} token`
            );
            if (colorId !== null) {
              token.style.backgroundColor = COLORS[colorId].hex;
            } else {
              token.classList.add("m-history__token--empty");
            }
            guess.appendChild(token);
          });

          const feedback = document.createElement("div");
          feedback.className = "m-history__feedback";
          const feedbackPegs = [
            ...Array(attempt.black).fill("black"),
            ...Array(attempt.white).fill("white"),
            ...Array(CODE_LENGTH - attempt.black - attempt.white).fill("empty"),
          ];
          feedbackPegs.forEach((type, pegIndex) => {
            const socket = createSocket(
              "small",
              `Attempt ${index + 1}, feedback socket ${pegIndex + 1}`
            );
            if (type === "black") {
              const peg = document.createElement("div");
              peg.className = "peg small black";
              socket.appendChild(peg);
            } else if (type === "white") {
              const peg = document.createElement("div");
              peg.className = "peg small white";
              socket.appendChild(peg);
            }
            feedback.appendChild(socket);
          });

          row.appendChild(guess);
          row.appendChild(feedback);
          mobileHistoryListEl.appendChild(row);
        });
      }

      function renderPalette(targetEl) {
        targetEl.innerHTML = "";
        const allowDrag = !isTouchLayout();
        COLORS.forEach((color) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "tray-peg";
          button.setAttribute("aria-label", color.name);
          button.title = color.name;
          button.disabled = state.status !== "playing";
          button.draggable = state.status === "playing" && allowDrag;
          if (selectedColorId === color.id) {
            button.classList.add("selected");
          }

          const peg = createPeg(color.hex, "large");
          button.appendChild(peg);

          button.addEventListener("click", () => {
            if (selectedColorId === color.id) {
              selectedColorId = null;
            } else {
              selectedColorId = color.id;
            }
            debugLog("Palette selected", { colorId: selectedColorId });
            renderAll();
            updateStatus();
          });

          button.addEventListener("dragstart", (event) => {
            if (allowDrag) {
              event.dataTransfer.setData("text/plain", color.id.toString());
            }
          });

          targetEl.appendChild(button);
        });
      }

      function renderPalettes() {
        renderPalette(paletteDesktopEl);
        renderPalette(paletteMobileEl);
      }

      function renderAll() {
        renderAttempts();
        renderMobileCurrentRow();
        renderMobileHistory();
        renderSecretCode();
        renderMobileSecretCode();
        renderPalettes();
      }

      function updateStatus() {
        const attemptNumber = state.attempts.length + 1;
        const attemptText =
          state.status === "playing"
            ? `Attempt ${attemptNumber} / ${MAX_ATTEMPTS}`
            : `Attempts used: ${state.attempts.length} / ${MAX_ATTEMPTS}`;
        attemptCounterEl.textContent = attemptText;
        statusEl.textContent = `Status: ${state.status.charAt(0).toUpperCase()}${state.status.slice(1)}`;
        mobileAttemptCounterEl.textContent = attemptText;
        mobileStatusEl.textContent = `Status: ${state.status.charAt(0).toUpperCase()}${state.status.slice(1)}`;
        submitBtn.disabled =
          state.status !== "playing" || state.currentGuess.some((slot) => slot === null);
        clearBtn.disabled = state.status !== "playing";
        mobileSubmitBtn.disabled =
          state.status !== "playing" || state.currentGuess.some((slot) => slot === null);
        mobileClearBtn.disabled = state.status !== "playing";
        mobileBackspaceBtn.disabled = state.status !== "playing";

        statusLiveEl.textContent =
          state.status === "playing"
            ? `Attempt ${attemptNumber}.`
            : `Game ${state.status}.`;
      }

      function clearGuess() {
        state.currentGuess = Array(CODE_LENGTH).fill(null);
        renderAll();
        updateStatus();
      }

      function backspaceGuess() {
        if (state.status !== "playing") {
          return;
        }
        for (let i = CODE_LENGTH - 1; i >= 0; i -= 1) {
          if (state.currentGuess[i] !== null) {
            state.currentGuess[i] = null;
            break;
          }
        }
        renderAll();
        updateStatus();
      }

      function submitGuess() {
        if (state.status !== "playing") {
          return;
        }
        if (state.currentGuess.some((slot) => slot === null)) {
          return;
        }

        const guess = state.currentGuess.slice();
        const result = evaluateGuess(state.secretCode, guess);
        state.attempts.push({ guess, black: result.black, white: result.white });

        statusLiveEl.textContent = `Black ${result.black}, White ${result.white}.`;

        if (result.black === CODE_LENGTH) {
          state.status = "won";
        } else if (state.attempts.length >= MAX_ATTEMPTS) {
          state.status = "lost";
        }

        state.currentGuess = Array(CODE_LENGTH).fill(null);
        renderAll();
        updateStatus();
      }

      function startNewGame() {
        // State handling for a new game.
        state.secretCode = generateSecretCode();
        state.attempts = [];
        state.currentGuess = Array(CODE_LENGTH).fill(null);
        state.status = "playing";
        selectedColorId = null;
        renderAll();
        updateStatus();
      }

      function isTouchLayout() {
        return window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT}px)`).matches;
      }

      function updateDebugIndicator() {
        if (!DEBUG_UI) {
          debugIndicatorEl.hidden = true;
          return;
        }
        const scrollWidth = document.documentElement.scrollWidth;
        const viewportWidth = window.innerWidth;
        const overflow = scrollWidth > viewportWidth;
        debugIndicatorEl.hidden = false;
        debugIndicatorEl.textContent = `vw ${viewportWidth}px | sw ${scrollWidth}px | overflow ${overflow}`;
      }

      function updateResponsiveLayout() {
        if (isTouchLayout()) {
          document.documentElement.style.setProperty("--board-scale", "1");
          document.body.classList.remove("condensed");
          renderAll();
          updateDebugIndicator();
          return;
        }
        const availableWidth = boardFrameEl.clientWidth - 16;
        const playfieldWidth = boardPlayfieldEl.scrollWidth;
        const scale = Math.min(1, availableWidth / playfieldWidth);
        document.documentElement.style.setProperty("--board-scale", scale.toFixed(3));

        const minTapTarget = 40;
        const socketBaseSize = parseFloat(
          getComputedStyle(document.documentElement).getPropertyValue("--socket-size")
        );
        const effectiveSize = socketBaseSize * scale;
        const shouldCondense = effectiveSize < minTapTarget;
        const hadCondensed = document.body.classList.contains("condensed");
        document.body.classList.toggle("condensed", shouldCondense);

        if (shouldCondense !== hadCondensed) {
          requestAnimationFrame(updateResponsiveLayout);
          return;
        }

        renderAll();
        updateDebugIndicator();
      }

      submitBtn.addEventListener("click", submitGuess);
      clearBtn.addEventListener("click", clearGuess);
      newGameBtn.addEventListener("click", startNewGame);
      mobileSubmitBtn.addEventListener("click", submitGuess);
      mobileClearBtn.addEventListener("click", clearGuess);
      mobileBackspaceBtn.addEventListener("click", backspaceGuess);
      mobileNewGameBtn.addEventListener("click", startNewGame);
      window.addEventListener("resize", updateResponsiveLayout);
      window.addEventListener("orientationchange", updateResponsiveLayout);

      runFeedbackTests();
      renderRowNumbers();
      startNewGame();
      updateResponsiveLayout();
      updateDebugIndicator();
    </script>
  </body>
</html>
